<template>
   <div class="episode-scenariste-details-page">
  <div class="app-wrapper-global">
    <!-- Sidebar latérale - Même structure que ProjetScenariste.vue -->
    <div class="creation-sidebar-projet-scenariste">
      <div class="sidebar-header-projet-scenariste">
        <h2 class="sidebar-title-projet-scenariste">Détails Épisode</h2>
        <p class="sidebar-subtitle-projet-scenariste">Gérez votre épisode et ses séquences</p>
      </div>

      <!-- Section Actions Rapides -->
      <div class="sidebar-section-projet-scenariste">
        <h3 class="section-title-projet-scenariste">
          <i class="fas fa-bolt"></i> Actions Rapides
        </h3>
        <div class="sidebar-actions-projet-scenariste">
          <button 
            @click="goToAddSequence" 
            class="sidebar-btn-projet-scenariste nouvelle-sequence-btn"
          >
            <i class="fas fa-plus"></i>
            Nouvelle séquence
          </button>
          <button 
            @click="goBack" 
            class="sidebar-btn-projet-scenariste"
          >
            <i class="fas fa-arrow-left"></i>
            Retour aux épisodes
          </button>
        </div>
      </div>

      <!-- Section Filtres -->
      <div class="sidebar-section-projet-scenariste">
        <h3 class="section-title-projet-scenariste">
          <i class="fas fa-filter"></i> Filtres Séquences
        </h3>
        <div class="filter-group-projet-scenariste">
          <div class="filter-item-projet-scenariste">
            <label for="timePeriodFilter">Période de mise à jour</label>
            <select 
              id="timePeriodFilter" 
              v-model="filterTimePeriod" 
              class="filter-select-projet-scenariste"
            >
              <option value="all">Toutes les périodes</option>
              <option value="today">Aujourd'hui</option>
              <option value="this_week">Cette semaine</option>
              <option value="this_month">Ce mois-ci</option>
              <option value="this_year">Cette année</option>
              <option value="recent">Récent (7 derniers jours)</option>
            </select>
          </div>
          
          <div class="filter-item-projet-scenariste">
            <label for="statutFilter">Statut</label>
            <select 
              id="statutFilter" 
              v-model="filterStatut" 
              class="filter-select-projet-scenariste"
            >
              <option value="">Tous</option>
              <option v-for="statut in statutsSequence" :key="statut.id" :value="statut.nomStatutsSequence">
                {{ statut.nomStatutsSequence }}
              </option>
            </select>
          </div>
        </div>
      </div>

      <!-- Section Statistiques -->
      <div class="sidebar-section-projet-scenariste">
        <h3 class="section-title-projet-scenariste">
          <i class="fas fa-chart-bar"></i> Statistiques
        </h3>
        <div class="stats-projet-scenariste">
          <div class="stat-item-projet-scenariste">
            <span class="stat-number-projet-scenariste">{{ sequences.length }}</span>
            <span class="stat-label-projet-scenariste">Total séquences</span>
          </div>
          <div class="stat-item-projet-scenariste">
            <span class="stat-number-projet-scenariste">{{ filteredSequences.length }}</span>
            <span class="stat-label-projet-scenariste">Séquences filtrées</span>
          </div>
          <div class="stat-item-projet-scenariste">
            <span class="stat-number-projet-scenariste">{{ commentCount }}</span>
            <span class="stat-label-projet-scenariste">Commentaires</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Contenu principal à droite -->
    <div class="creation-body-projet-scenariste">
      <div class="creation-main-content-projet-scenariste">
        
        <!-- Message d'accès refusé -->
        <div v-if="accessDenied" class="access-denied">
          <div class="access-denied-content">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Accès refusé</h3>
            <p>Vous n'avez pas les droits nécessaires pour accéder à cet épisode.</p>
            <button @click="goBack" class="back-btn">Retour au projet</button>
          </div>
        </div>

        <!-- Contenu principal -->
        <main v-else>

          <transition name="slide-fade">
             <div v-if="showAddSequenceForm" class="add-sequence-slide-container">
                <div class="add-sequence-container">

    <!-- Contenu principal -->
    <main class="main-content">
      <div class="sequence-header">
        <button @click="goBack" class="back-btn">← Retour</button>
        <h2>Ajouter une nouvelle séquence</h2>
      </div>

      <!-- Formulaire d'ajout de séquence -->
      <div class="add-sequence-form">
        <form @submit.prevent="submitForm">
          <div class="form-group">
            <label for="titre">Titre de la séquence</label>
            <input
              id="titre"
              v-model="formData.titre"
              type="text"
              required
              placeholder="Entrez le titre de la séquence"
            />
          </div>

          <div class="form-group">
            <label for="ordre">Ordre dans l'épisode</label>
            <input
              id="ordre"
              v-model="formData.ordre"
              type="number"
              min="1"
              required
              placeholder="Numéro d'ordre"
              :class="{ 'error-input': ordreError }"
              @blur="validateOrdre"
            />
            <span v-if="ordreError" class="error-text">{{ ordreError }}</span>
            <span v-if="suggestedOrdre" class="suggestion-text">
              Suggestion: Le prochain ordre disponible est {{ suggestedOrdre }}
               <button type="button" @click="useSuggestedOrder" class="suggestion-btn">
                Utiliser cette valeur
            </button>
            </span>
          </div>

          <div class="form-group">
            <label for="synopsis">Synopsis</label>
            <textarea
              id="synopsis"
              v-model="formData.synopsis"
              required
              rows="5"
              placeholder="Décrivez le contenu de cette séquence"
            ></textarea>
          </div>

          <div class="form-group">
            <label for="episode">Épisode lié</label>
            <input
              id="episode"
              :value="episode.titre"
              type="text"
              disabled
            />
          </div>

          <div class="form-group">
            <label for="statut">Statut *</label>
            <select
              id="statut"
              v-model="formData.statutId"
              required
            >
              <option value="" disabled>Sélectionnez un statut</option>
              <option 
                v-for="statut in statutsSequence" 
                :key="statut.id" 
                :value="statut.id"
              >
                {{ statut.nomStatutsSequence }}
              </option>
            </select>
          </div>

          <div class="form-actions">
            <button 
              type="submit" 
              class="submit-btn"
              :disabled="loading || ordreError !== ''"
            >
              {{ loading ? 'Création en cours...' : 'Créer la séquence' }}
            </button>
            <button 
              type="button" 
              @click="goBack" 
              class="cancel-btn"
            >
              Annuler
            </button>
          </div>
        </form>
      </div>
    </main>
  </div>

             </div>
          </transition>
           <div :class="{ 'blur-content': showAddSequenceForm }">
             <main v-if="!showAddSequenceForm && !accessDenied">
           

          <!-- Détails de l'épisode -->
          <div class="project-details-spiral-Scenariste">
            <div class="project-info-spiral-Scenariste">
              <div class="project-main-content-Scenariste">
                <div class="project-header-spiral-Scenariste">
                  <h3 class="project-title-spiral-Scenariste">
                    <i class="fas fa-film"></i>
                    {{ episode.titre }}
                  </h3>
                  <span class="project-statut-badge-Scenariste" :class="getStatutClass(episode.statutNom)">
                    {{ episode.statutNom }}
                  </span>
                </div>
                 <div class="project-meta-spiral-Scenariste"> 
                 <!-- <div class="meta-item-spiral-Scenariste">
                    <i class="fas fa-list-ol"></i>
                    <span class="meta-label">Ordre:</span>
                    <span class="meta-value">{{ episode.ordre }}</span>
                  </div>  -->
                
                  <div class="meta-item-spiral-Scenariste">
                    <i class="fas fa-calendar-alt"></i>
                    <span class="meta-label">Créé le:</span>
                    <span class="meta-value">{{ formatDate(episode.creeLe) }}</span>
                  </div>
                  <div class="meta-item-spiral-Scenariste">
                    <i class="fas fa-edit"></i>
                    <span class="meta-label">Modifié le:</span>
                    <span class="meta-value">{{ formatDate(episode.modifieLe) }}</span>
                  </div>
                  <div class="meta-item-spiral-Scenariste" v-if="episode.dateFin">
                    <i class="fas fa-calendar-check"></i>
                    <span class="meta-label">Terminé le:</span>
                    <span class="meta-value">{{ formatDate(episode.dateFin) }}</span>
                  </div>
          
                  <div class="meta-item-spiral-Scenariste" v-if="episode.scenariste">
                    <i class="fas fa-user-edit"></i>
                    <span class="meta-label">Scénariste:</span>
                    <span class="meta-value">{{ episode.scenariste.nom }}</span>
                  </div>
                  <div class="meta-item-spiral-Scenariste" v-else>
                    <i class="fas fa-user-edit"></i>
                    <span class="meta-label">Scénariste:</span>
                    <span class="meta-value">Non assigné</span>
                  </div>
                  
                  <div class="meta-item-spiral-Scenariste" v-if="episode.realisateur">
                    <i class="fas fa-video"></i>
                    <span class="meta-label">Réalisateur:</span>
                    <span class="meta-value">{{ episode.realisateur.nom }}</span>
                  </div>
                  <div class="meta-item-spiral-Scenariste" v-else>
                    <i class="fas fa-video"></i>
                    <span class="meta-label">Réalisateur:</span>
                    <span class="meta-value">Non assigné</span>
                  </div>
                </div>
                
                <div class="project-synopsis-spiral-Scenariste" v-if="episode.synopsis">
                  <h4>
                    <i class="fas fa-align-left"></i> Synopsis
                    <span class="comment-icon" @click="toggleCommentSection">
                      <i class="fas fa-comment"></i> {{ commentCount }}
                    </span>
                  </h4>
                  <p>{{ episode.synopsis }}</p>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
          <!-- Section Commentaires -->
          <div v-if="showCommentSection" class="comment-section">
            <div class="comment-header">
              <i class="fas fa-comments"></i>
              Commentaires
            </div>
            
            <!-- Formulaire d'ajout de commentaire -->
            <div class="add-comment">
              <textarea v-model="newComment" placeholder="Ajouter un commentaire..." rows="3"></textarea>
              <button @click="addComment" class="add-comment-btn">
                <i class="fas fa-paper-plane"></i> Ajouter
              </button>
            </div>
            
            <!-- Liste des commentaires -->
            <div class="comments-list">
              <div v-for="comment in comments" :key="comment.id" class="comment-item">
                <div class="comment-header">
                  <span class="comment-author">{{ comment.utilisateurNom }}</span>
                  <span class="comment-date">{{ formatDate(comment.creeLe) }}</span>
                </div>
                <div class="comment-content">
                  {{ comment.contenu }}
                </div>
                <div class="comment-actions" v-if="comment.utilisateurId === user.id">
                  <button @click="deleteComment(comment.id)" class="delete-comment-btn">
                    <i class="fas fa-trash"></i> Supprimer
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Section séquences -->
          <div class="episodes-section-projet-scenariste">
            <div class="section-header-projet-scenariste">
              <h3>
                <i class="fas fa-list-ol"></i>
                Séquences de l'épisode
              </h3>
            </div>

            <!-- Liste des séquences -->
            <div class="projects-library-Scenariste">
              <div v-for="sequence in filteredSequences" :key="sequence.idSequence" class="movie-card-Scenariste">
                <!-- Header de la carte -->
                <div class="movie-card-header-Scenariste">
                  <div class="movie-statut-Scenariste">
                    <span class="statut-badge-Scenariste" :class="getStatutClass(sequence.statutNom)">
                      {{ sequence.statutNom }}
                    </span>
                  </div>
                  <div class="movie-actions-Scenariste">
                    <button class="action-btn-Scenariste edit-btn-Scenariste" @click.stop="startEditSequence(sequence)" title="Modifier">
                      <i class="fas fa-marker"></i>
                    </button>
                    <button class="action-btn-Scenariste delete-btn-Scenariste" @click.stop="confirmDeleteSequence(sequence.idSequence)" title="Supprimer">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
                
                <!-- Contenu de la carte -->
                <div class="movie-info-Scenariste">
                  <h3 class="movie-title-Scenariste">{{ sequence.titre }}</h3>
                  
                  <div class="movie-synopsis" v-if="sequence.synopsis">
                    <p>{{ truncateText(sequence.synopsis, 120) }}</p>
                  </div>
                                  
                  <!-- Métadonnées -->
                  <div class="movie-meta-Scenariste">
                    <i class="fas fa-list-ol"></i><span>Ordre: {{ sequence.ordre }}</span>
                    <span class="meta-separator-Scenariste">|</span>
                    <i class="fas fa-calendar"></i><span>{{ formatShortDate(sequence.creeLe) }}</span>
                  </div>
                  
                  <!-- Actions en bas de carte -->
                  <div class="movie-actions-bottom-Scenariste">
                    <div class="actions-top-Scenariste">
                      <button class="action-btn-Scenariste primary-btn" @click="goToSequenceDetails(sequence.idSequence)" title="Détails">
                        <i class="fas fa-search"></i>
                        <span>Voir détails</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Message si aucune séquence -->
            <div v-if="filteredSequences.length === 0" class="no-projects-Scenariste">
              <div class="no-projects-icon-Scenariste">
                <i class="fas fa-list-alt"></i>
              </div>
              <h3>Aucune séquence trouvée</h3>
              <p>Commencez par créer votre première séquence !</p>
              <button class="add-project-btn-large-Scenariste" @click="goToAddSequence">
                <i class="fas fa-plus-circle"></i>
                Créer une séquence
              </button>
            </div>
          </div>

          <!-- Modale pour modifier la séquence -->
          <div v-if="showEditModal" class="edit-project-modal-Scenariste">
            <div class="modal-content-Scenariste">
              <div class="modal-header-Scenariste">
                <h3><i class="fas fa-edit"></i> Modifier la Séquence</h3>
                <button @click="closeEditModal" class="close-modal-btn-Scenariste">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              
              <div class="modal-body-Scenariste">
                <!-- Message d'erreur général -->
                <div v-if="editError" class="error-message-Scenariste">
                  {{ editError }}
                </div>
                
                <div class="form-rows-container-Scenariste">
                  <!-- Ligne 1 : Titre + Ordre -->
                  <div class="form-row-Scenariste">
                    <div class="form-group-Scenariste">
                      <label>Titre de la séquence:</label>
                      <input v-model="editingSequence.titre" type="text" class="form-input-Scenariste" required>
                    </div>
                    
                    <div class="form-group-Scenariste">
                      <label>Ordre dans l'épisode:</label>
                      <input 
                        v-model="editingSequence.ordre" 
                        type="number" 
                        class="form-input-Scenariste"
                        :class="{ 'error-input': orderError }"
                        @blur="validateOrder"
                        required
                      >
                      <!-- Message d'erreur pour l'ordre -->
                      <div v-if="orderError" class="order-error">
                        {{ orderError }}
                      </div>
                      <!-- Suggestion d'ordre -->
                      <div v-if="suggestedOrder && !editingSequence.ordre" class="suggestion-text">
                        Suggestion: Le prochain ordre disponible est {{ suggestedOrder }}
                        <button type="button" @click="useSuggestedOrder" class="suggestion-btn-projet-scenariste">
                          Utiliser cette valeur
                        </button>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Ligne 2 : Statut -->
                  <div class="form-row-Scenariste">
                    <div class="form-group-Scenariste form-full-width-Scenariste">
                      <label>Statut:</label>
                      <select v-model="editingSequence.statutId" class="form-select-Scenariste" required>
                        <option value="">Sélectionnez un statut</option>
                        <option v-for="statut in statutsSequence" :key="statut.id" :value="statut.id">
                          {{ statut.nomStatutsSequence }}
                        </option>
                      </select>
                    </div>
                  </div>
                  
                  <!-- Ligne 3 : Synopsis -->
                  <div class="form-row-Scenariste">
                    <div class="form-group-Scenariste form-full-width-Scenariste">
                      <label>Synopsis:</label>
                      <textarea v-model="editingSequence.synopsis" class="form-textarea-Scenariste" rows="4" required></textarea>
                    </div>
                  </div>
                  
                  <!-- Ligne 4 : Épisode (lecture seule) -->
                  <div class="form-row-Scenariste">
                    <div class="form-group-Scenariste form-full-width-Scenariste">
                      <label>Épisode parent:</label>
                      <input :value="episode.titre" type="text" class="form-input-Scenariste" disabled>
                    </div>
                  </div>
                </div>
                
                <div class="modal-footer-Scenariste">
                  <button @click="closeEditModal" class="cancel-btn-Scenariste">Annuler</button>
                  <button type="submit" @click="saveEditedSequence" class="save-btn-Scenariste" :disabled="orderError !== ''">
                    <i class="fas fa-save"></i> Sauvegarder
                  </button>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Modal de confirmation de suppression -->
    <div v-if="showDeleteModal" class="delete-confirmation-modal-Scenariste">
      <div class="modal-overlay-Scenariste" @click="closeDeleteModal"></div>
      <div class="modal-content-confirm-Scenariste">
        <div class="modal-header-confirm-Scenariste">
          <h3><i class="fas fa-exclamation-triangle"></i> Confirmation de suppression</h3>
          <button @click="closeDeleteModal" class="close-modal-btn-Scenariste">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="modal-body-confirm-Scenariste">
          <div class="warning-icon-Scenariste">
            <i class="fas fa-trash"></i>
          </div>
          <p class="warning-text-Scenariste">
            Êtes-vous sûr de vouloir supprimer la séquence <strong>"{{ sequenceToDelete?.titre }}"</strong> ?
          </p>
          <p class="warning-subtext-Scenariste">
            Cette action est irréversible. Toutes les scènes associées à cette séquence seront également supprimées.
          </p>
        </div>
        
        <div class="modal-footer-confirm-Scenariste">
          <button @click="closeDeleteModal" class="cancel-confirm-btn-Scenariste">
            <i class="fas fa-times"></i> Annuler
          </button>
          <button @click="executeDeleteSequence" class="delete-confirm-btn-Scenariste" :disabled="isDeleting">
            <span v-if="isDeleting"><i class="fas fa-spinner fa-spin"></i> Suppression...</span>
            <span v-else><i class="fas fa-trash"></i> Supprimer définitivement</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Notification de succès/erreur -->
    <div v-if="notification.show" :class="['message-crea-profile', notification.type]" @click="hideNotification">
      <i :class="notification.type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'"></i>
      {{ notification.message }}
      <button class="message-close-crea-profile" @click.stop="hideNotification">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>
  </div>
</template>

<script>
import axios from 'axios';

export default {
  data() {
    return {
      user: JSON.parse(localStorage.getItem('user')) || null,
      episode: {
        scenariste: null,
        realisateur: null
      },
      sequences: [],
      statutsSequence: [],
      accessDenied: false, 
      userEpisodes: [],
      filterTimePeriod: 'all',
      filterStatut: '',
      showEditModal: false,
      editingSequence: {
        idSequence: null,
        titre: '',
        synopsis: '',
        ordre: null,
        statutId: null,
      },
      showCommentSection: false,
      newComment: '',
      comments: [],
      commentCount: 0,
      editError: '', 
      orderError: '', 
      suggestedOrder: null, 
      existingOrders: [],
      originalOrder: null,
      showDeleteModal: false,
      sequenceToDelete: null,
      isDeleting: false,
      deleteError: '',
      notification: {
        show: false,
        message: '',
        type: 'success'
      },
      notificationTimeout: null,
       showAddSequenceForm: false,
      newSequenceData: {
        titre: '',
        ordre: null,
        synopsis: '',
        statutId: null
      },
    };
  },
  computed: {
    filteredSequences() {
      let filtered = this.sequences;

      // Filtrer par statut
      if (this.filterStatut) {
        filtered = filtered.filter(sequence => sequence.statutNom === this.filterStatut);
      }

      // Filtrer par période
      const now = new Date();
      filtered = filtered.filter(sequence => {
        const modifieLe = new Date(sequence.modifieLe);
        switch (this.filterTimePeriod) {
          case 'today':
            return modifieLe.toDateString() === now.toDateString();
          case 'this_week':
            const oneWeekAgo = new Date(now);
            oneWeekAgo.setDate(now.getDate() - 7);
            return modifieLe >= oneWeekAgo;
          case 'this_month':
            return modifieLe.getMonth() === now.getMonth() && modifieLe.getFullYear() === now.getFullYear();
          case 'this_year':
            return modifieLe.getFullYear() === now.getFullYear();
          case 'recent':
            const sevenDaysAgo = new Date(now);
            sevenDaysAgo.setDate(now.getDate() - 7);
            return modifieLe >= sevenDaysAgo;
          default:
            return true;
        }
      });

      return filtered;
    },
  },
  async created() {
    await this.loadUserEpisodes(); 
    await this.checkAccess(); 
    if (!this.accessDenied) {
      await this.loadEpisode();
      await this.loadSequences();
      await this.loadStatutsSequence();
      await this.loadCommentCount();
    }
  },
  methods: {
    async loadUserEpisodes() {
        try {
          const response = await axios.get(`/api/episodes/utilisateur/${this.user.id}`);
          this.userEpisodes = response.data;
        } catch (error) {
          console.error('Erreur lors du chargement des épisodes utilisateur:', error);
        }
    },
    async checkAccess() {
      const episodeId = parseInt(this.$route.params.id);
      
      // Les admins ont accès à tout
      if (this.user.role === 'ADMIN') {
        this.accessDenied = false;
        return;
      }

      // Vérifier si l'épisode actuel est dans la liste des épisodes accessibles
      const hasAccess = this.userEpisodes.some(ep => ep.idEpisode === episodeId);
      
      if (!hasAccess) {
        this.accessDenied = true;
      }
    },
    async loadEpisode() {
      try {
        const response = await axios.get(`/api/episodes/${this.$route.params.id}`, {
          headers: {
            'X-User-Id': this.user.id
          }
        });
        this.episode = response.data;
        
      } catch (error) {
        if (error.response?.status === 403) {
          this.accessDenied = true;
        } else {
          console.error('Erreur lors du chargement de l\'épisode:', error);
        }
      }
    },
    async loadSequences() {
      try {
        const response = await axios.get(`/api/sequences/episodes/${this.$route.params.id}`, {
          headers: {
            'X-User-Id': this.user.id
          }
        });
        this.sequences = response.data;
      } catch (error) {
        console.error('Erreur lors du chargement des séquences:', error);
      }
    },
    async loadStatutsSequence() {
      try {
        const response = await axios.get('/api/statuts-sequence');
        this.statutsSequence = response.data;
      } catch (error) {
        console.error('Erreur lors du chargement des statuts:', error);
      }
    },

     goToAddSequence() {
      this.showAddSequenceForm = true;
      this.calculateSuggestedOrdre();
    },
    
    closeAddSequence() {
      this.showAddSequenceForm = false;
      this.resetSequenceForm();
    },
    
    async submitSequenceForm() {
      // Copiez la logique de submitForm de AddSequence.vue
      try {
        const user = JSON.parse(localStorage.getItem('user'));
        const response = await axios.post(`/api/sequences/episodes/${this.episode.idEpisode}`, this.newSequenceData, {
          headers: { 'X-User-Id': user.id }
        });
        
        alert('Séquence créée avec succès!');
        this.closeAddSequence();
        await this.loadSequences(); // Recharger la liste
      } catch (error) {
        console.error('Erreur:', error);
      }
    },
    
    resetSequenceForm() {
      this.newSequenceData = {
        titre: '',
        ordre: null,
        synopsis: '',
        statutId: null
      };
    },
    
    async calculateSuggestedOrdre() {
      try {
        const response = await axios.get(`/api/sequences/episodes/${this.episode.idEpisode}`);
        const existingOrders = response.data.map(s => s.ordre);
        
        if (existingOrders.length === 0) {
          this.newSequenceData.ordre = 1;
        } else {
          const maxOrder = Math.max(...existingOrders);
          this.newSequenceData.ordre = maxOrder + 1;
        }
      } catch (error) {
        console.error('Erreur:', error);
      }
    },
    async loadComments() {
      try {
        const response = await axios.get(`/api/commentaires/episode/${this.$route.params.id}`);
        this.comments = response.data;
      } catch (error) {
        console.error('Erreur lors du chargement des commentaires:', error);
      }
    },
    async loadCommentCount() {
      try {
        const response = await axios.get(`/api/commentaires/episode/${this.$route.params.id}/count`);
        this.commentCount = response.data;
      } catch (error) {
        console.error('Erreur lors du chargement du nombre de commentaires:', error);
      }
    },
    toggleCommentSection() {
      this.showCommentSection = !this.showCommentSection;
      if (this.showCommentSection) {
        this.loadComments();
      }
    },
    async addComment() {
      if (!this.newComment.trim()) return;
      
      try {
        await axios.post('/api/commentaires', {
          contenu: this.newComment,
          episodeId: this.$route.params.id
        }, {
          headers: {
            'X-User-Id': this.user.id
          }
        });
        
        this.newComment = '';
        await this.loadComments();
        await this.loadCommentCount();
      } catch (error) {
        console.error('Erreur lors de l\'ajout du commentaire:', error);
        this.showNotification('Erreur lors de l\'ajout du commentaire', 'error');
      }
    },
    async deleteComment(commentId) {
      // if (confirm('Êtes-vous sûr de vouloir supprimer ce commentaire ?')) {
        try {
          await axios.delete(`/api/commentaires/${commentId}`);
          await this.loadComments();
          await this.loadCommentCount();
          // this.showNotification('Commentaire supprimé avec succès!', 'success');
        } catch (error) {
          console.error('Erreur lors de la suppression du commentaire:', error);
          this.showNotification('Erreur lors de la suppression du commentaire', 'error');
        }
      // }
    },
    startEditSequence(sequence) {
      this.editingSequence = {
        idSequence: sequence.idSequence,
        titre: sequence.titre,
        synopsis: sequence.synopsis,
        ordre: sequence.ordre,
        statutId: this.getStatutIdByNom(sequence.statutNom),
      };
      this.originalOrder = sequence.ordre;
      this.showEditModal = true;
      
      this.loadExistingOrders();
    },
    async loadExistingOrders() {
      try {
        const response = await axios.get(`/api/sequences/episodes/${this.$route.params.id}`);
        
        this.existingOrders = response.data
          .filter(sequence => sequence.idSequence !== this.editingSequence.idSequence)
          .map(sequence => sequence.ordre);
        
        this.calculateSuggestedOrder();
      } catch (error) {
        console.error('Erreur lors du chargement des ordres existants:', error);
      }
    },
    calculateSuggestedOrder() {
      if (this.existingOrders.length === 0) {
        this.suggestedOrder = 1;
      } else {
        const maxOrder = Math.max(...this.existingOrders);
        this.suggestedOrder = maxOrder + 1;
      }
    },
    validateOrder() {
      if (!this.editingSequence.ordre) {
        this.orderError = 'L\'ordre est requis';
        return;
      }
      
      const orderNum = parseInt(this.editingSequence.ordre);
      
      if (orderNum < 1) {
        this.orderError = 'L\'ordre doit être un nombre positif';
        return;
      }
      
      if (this.existingOrders.includes(orderNum) && orderNum !== this.originalOrder) {
        this.orderError = `L'ordre ${orderNum} existe déjà pour cet épisode. Veuillez choisir un autre numéro.`;
        return;
      }
      
      this.orderError = '';
    },
    useSuggestedOrder() {
      this.editingSequence.ordre = this.suggestedOrder;
      this.validateOrder();
    },
    getStatutIdByNom(nom) {
      const statut = this.statutsSequence.find(s => s.nomStatutsSequence === nom);
      return statut ? statut.id : null;
    },
    getStatutClass(statutNom) {
      if (!statutNom) return '';
      
      const statut = statutNom.toLowerCase();
      if (statut.includes('en cours') || statut.includes('actif')) {
        return 'statut-en-cours';
      } else if (statut.includes('terminé') || statut.includes('complet')) {
        return 'statut-termine';
      } else if (statut.includes('attente') || statut.includes('en attente')) {
        return 'statut-attente';
      } else if (statut.includes('annulé') || statut.includes('abandonné')) {
        return 'statut-annule';
      } else if (statut.includes('planifié') || statut.includes('planification')) {
        return 'statut-planifie';
      } else {
        return 'statut-attente';
      }
    },
    async saveEditedSequence() {
      this.validateOrder();
      if (this.orderError) {
        return;
      }
      
      try {
        const response = await axios.put(`/api/sequences/${this.editingSequence.idSequence}`, {
          titre: this.editingSequence.titre,
          synopsis: this.editingSequence.synopsis,
          ordre: parseInt(this.editingSequence.ordre),
          statutId: this.editingSequence.statutId,
        });
        
        this.showEditModal = false;
        this.editError = '';
        this.orderError = '';
        await this.loadSequences();
        this.showNotification('Séquence modifiée avec succès!', 'success');
      } catch (error) {
        console.error('Erreur lors de la mise à jour de la séquence:', error);
        
        if (error.response?.status === 400 && 
            error.response?.data?.message?.includes('ordre')) {
          this.orderError = 'Cet ordre existe déjà pour cet épisode. Veuillez choisir un autre numéro.';
          this.editError = 'Erreur de validation: ' + this.orderError;
          this.showNotification(this.orderError, 'error');
        } else {
          this.editError = error.response?.data?.message || 'Erreur lors de la mise à jour de la séquence';
          this.showNotification(this.editError, 'error');
        }
      }
    },
    closeEditModal() {
      this.showEditModal = false;
      this.editingSequence = {
        idSequence: null,
        titre: '',
        synopsis: '',
        ordre: null,
        statutId: null,
      };
      this.editError = '';
      this.orderError = '';
      this.suggestedOrder = null;
      this.existingOrders = [];
      this.originalOrder = null;
      this.hideNotification();
    },
    async confirmDeleteSequence(sequenceId) {
      const sequence = this.sequences.find(seq => seq.idSequence === sequenceId);
      if (!sequence) return;
      
      this.sequenceToDelete = sequence;
      this.showDeleteModal = true;
      this.deleteError = '';
    },
    closeDeleteModal() {
      this.showDeleteModal = false;
      this.sequenceToDelete = null;
      this.isDeleting = false;
      this.deleteError = '';
    },
    async executeDeleteSequence() {
      if (!this.sequenceToDelete) return;
      
      this.isDeleting = true;
      
      try {
        await axios.delete(`/api/sequences/${this.sequenceToDelete.idSequence}`);
        await this.loadSequences();
        this.closeDeleteModal();
        this.showNotification('Séquence supprimée avec succès!', 'success');
      } catch (error) {
        console.error('Erreur lors de la suppression de la séquence:', error);
        this.showNotification('Erreur lors de la suppression de la séquence', 'error');
        this.isDeleting = false;
      }
    },
    goToAddSequence() {
      this.$router.push(`/episode/${this.episode.idEpisode}/add-sequence`);
    },
    goToSequenceDetails(sequenceId) {
      this.$router.push(`/sequence/${sequenceId}/detail-sequence`);
    },
    goBack() {
      this.$router.push(`/projet/${this.episode.projetId}`);
    },
    formatDate(date) {
      if (!date) return 'Non spécifié';
      return new Date(date).toLocaleDateString('fr-FR', {
        day: 'numeric',
        month: 'long',
        year: 'numeric',
        // hour: '2-digit',
        // minute: '2-digit'
      });
    },
    formatShortDate(date) {
      if (!date) return '';
      return new Date(date).toLocaleDateString('fr-FR', {
        day: 'numeric',
        month: 'short'
      });

    },
    formatCompactDate(date) {
      if (!date) return '';
      const d = new Date(date);
      return `${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear().toString().slice(-2)}`;
    },
    truncateText(text, length) {
      if (!text) return '';
      if (text.length <= length) return text;
      return text.substring(0, length) + '...';
    },
    showNotification(message, type = 'success') {
      this.notification = {
        show: true,
        message: message,
        type: type
      };
      
      if (this.notificationTimeout) {
        clearTimeout(this.notificationTimeout);
      }
      
      this.notificationTimeout = setTimeout(() => {
        this.hideNotification();
      }, 5000);
    },
    hideNotification() {
      this.notification.show = false;
      this.notification.message = '';
      if (this.notificationTimeout) {
        clearTimeout(this.notificationTimeout);
        this.notificationTimeout = null;
      }
    }
  }
};
</script>
